
# Better prefix
set -g prefix C-Space
unbind C-b

# For smart pane switchin with Vim, see bindings
set -g set-titles on

# Enable all the mouse support
setw -g mouse on
bind -n WheelUpPane   if -Ft= "#{mouse_any_flag}" "selectp -t=; send -M" "if -Ft= '#{alternate_on}' 'selectp -t=; send up'   'if -Ft= \"#{pane_in_mode}\" \"send -M\" \"selectp -t=; copy-mode -e; send -M\"'"
bind -n WheelDownPane if -Ft= "#{mouse_any_flag}" "selectp -t=; send -M" "if -Ft= '#{alternate_on}' 'selectp -t=; send Down' 'selectp -t=; send -M'"
bind -T copy-mode-vi C-WheelUpPane   send -X halfpage-up
bind -T copy-mode-vi C-WheelDownPane send -X halfpage-down
unbind -T copy-mode-vi  MouseDragEnd1Pane
bind -n DoubleClick1Pane select-pane \; copy-mode -M \; send-keys -X select-word

# Mouse wheel scrolling
set -g terminal-overrides 'xterm*:smcup@:rmcup@'

# Things work better with this
setw -g xterm-keys on

# Better for Vim
set -sg escape-time 1

# Better indexing
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Everyone's doing it...
setw -g aggressive-resize on

# Show running command in window tab
setw -g automatic-rename on

# Do it right
set -g default-terminal screen-256color

# More to scroll back to
set -g history-limit 10000

set -g display-time 5000
set -g display-panes-time 5000

# Prevent C-d killing tmux
set-environment -g 'IGNOREEOF' 2

# Vim-style keys for copy-mode
set -g mode-keys vi

# Support copy/paste on Mac OS X
set -g default-command "which reattach-to-user-namespace >/dev/null && reattach-to-user-namespace -l bash || bash"

# This tmux statusbar config was created by tmuxline.vim
# on Tue, 07 Oct 2014
set -g status-left-length 32
set -g status-right-length 150
set -g status-interval 5
set -g status-bg "colour234"
set -g message-command-fg "colour255"
set -g status-justify "left"
set -g status-left-length "100"
set -g status "on"
set -g pane-active-border-fg colour39
set -g pane-active-border-bg colour234
set -g message-bg "colour238"
set -g status-right-length "100"
set -g status-right-attr "none"
set -g message-fg "colour255"
set -g message-command-bg "colour238"
set -g status-attr "none"
set -g pane-border-fg "colour238"
set -g status-left-attr "none"
setw -g window-status-fg "colour85"
setw -g window-status-attr "none"
setw -g window-status-activity-bg "colour234"
setw -g window-status-activity-attr "none"
setw -g window-status-activity-fg "colour190"
setw -g window-status-separator ""
setw -g window-status-bg "colour234"
set -g status-left "#[fg=colour17,bg=colour190] #S #[fg=colour190,bg=colour234,nobold,nounderscore,noitalics]"
set -g status-right "#[fg=colour238,bg=colour234,nobold,nounderscore,noitalics]#[fg=colour255,bg=colour238] %Y-%m-%d  %H:%M #[fg=colour190,bg=colour238,nobold,nounderscore,noitalics]#[fg=colour17,bg=colour190] #h "
setw -g window-status-format "#[fg=colour85,bg=colour234] #I: #[fg=colour85,bg=colour234]#W "
setw -g window-status-current-format "#[fg=colour234,bg=colour238,nobold,nounderscore,noitalics]#[fg=colour255,bg=colour238] #I: #[fg=colour255,bg=colour238]#W #[fg=colour238,bg=colour234,nobold,nounderscore,noitalics]"

# Manual theme stuff
set -g window-style 'fg=colour250,bg=colour233'
set -g window-active-style 'fg=colour231,bg=black'


###
### Key bindings are after options since the if-shell below apparently creates a client session
### earlier than expects and some options weren't being set.... or something...
###

# Smart pane switching with awareness of vim splits
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind -n C-h if-shell "$is_vim" "send-keys C-h"  "select-pane -L"
bind -n C-j if-shell "$is_vim" "send-keys C-j"  "select-pane -D"
bind -n C-k if-shell "$is_vim" "send-keys C-k"  "select-pane -U"
bind -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"

bind -r C-h select-window -t :-
bind -r C-l select-window -t :+

bind -r Up resize-pane -U 5
bind -r Down resize-pane -D 5
bind -r Left resize-pane -L 5
bind -r Right resize-pane -R 5

bind -r C-Up move-pane -s '{marked}' -v -b
bind -r C-Down move-pane -s '{marked}' -v
bind -r C-Left move-pane -s '{marked}' -h -b
bind -r C-Right move-pane -s '{marked}' -h

bind Space send-prefix

if-shell '[[ `tmux -V` == *1.9* || `tmux -V` == *2.* ]]' "bind s split-window -vb -c '#{pane_current_path}'" "bind s split-window -vb"
if-shell '[[ `tmux -V` == *1.9* || `tmux -V` == *2.* ]]' "bind v split-window -h -c '#{pane_current_path}'" "bind v split-window -h"
if-shell '[[ `tmux -V` == *1.9* || `tmux -V` == *2.* ]]' "bind c new-window -c '#{pane_current_path}'" "bind c new-window"
bind S split-window -vbf -c '#{pane_current_path}'
bind V split-window -hf -c '#{pane_current_path}'
unbind %
unbind '"'

bind w choose-session
bind C-w choose-session "kill-session -t '%%'"

bind X confirm-before -p "kill-window #W? (y/n)" kill-window

bind r source-file ~/.tmux.conf ; display "tmux config reloaded!"

bind Escape copy-mode
bind p paste-buffer
bind -T copy-mode-vi 'Space' send -X begin-selection
bind -T copy-mode-vi 'v' send -X begin-selection
bind -T copy-mode-vi 'y' send -X copy-pipe-and-cancel "which reattach-to-user-namespace >/dev/null && reattach-to-user-namespace pbcopy || xclip -i -selection clip"
bind C-y run "tmux save-buffer - | (which reattach-to-user-namespace >/dev/null && reattach-to-user-namespace pbcopy || xclip -i -selection clip)"

bind 1 run-shell 'tmuxinator macadamian'
bind 2 run-shell 'tmuxinator gerrit'
bind 3 run-shell 'tmuxinator rc'

bind < swap-window -t -1
bind > swap-window -t +1

bind , command-prompt "rename-window '%%'"

bind ` show-messages

bind = run-shell "tmux lsw -F '#{window_active} #{window_layout}' | awk '$1 == 1 {print $2}' | xargs ~/.tmux/equalize-layout.js | xargs tmux select-layout"


###
### Tmux Plugin Manager
###

set -g @copycat_next 'N'
set -g @copycat_prev 'n'

set -g @copycat_hash_search 'C-g'
set -g @copycat_git_special 'C-q'

set -g @tpm_plugins "          \
  tmux-plugins/tpm             \
  tmux-plugins/tmux-resurrect  \
  Morantron/tmux-fingers       \
  tmux-plugins/tmux-copycat    \
"
run-shell ~/.tmux/plugins/tpm/tpm
